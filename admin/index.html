<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Post</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css">
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; }
        .hidden { display: none; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input, textarea { width: 100%; padding: 0.5rem; box-sizing: border-box; }
        button { background: #24292e; color: white; border: none; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 1rem; border-radius: 4px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #login-screen { max-width: 400px; margin: 4rem auto; text-align: center; }
        .error { color: red; margin-top: 0.5rem; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <h1>Contributor Login</h1>
        <div class="form-group">
            <input type="password" id="password-input" placeholder="Enter the password" onkeyup="if(event.key === 'Enter') login()">
        </div>
        <button onclick="login()">Unlock</button>
        <p id="login-error" class="error"></p>
    </div>

    <!-- Editor Screen -->
    <div id="editor-screen" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Manage Posts</h1>
            <button onclick="resetEditor()" style="background: #666; font-size: 0.9rem; padding: 0.5rem 1rem;">New Post</button>
        </div>

        <div id="posts-list" style="margin-bottom: 2rem; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px;">
            <p style="color: #666; text-align: center;">Loading posts...</p>
        </div>

        <h2 id="form-title">Write a New Post</h2>
        
        <div class="form-group">
            <label>Title</label>
            <input type="text" id="post-title" placeholder="My Awesome Story">
        </div>

        <div class="form-group">
            <label>Content</label>
            <textarea id="post-body"></textarea>
        </div>

        <button id="publish-btn" onclick="publish()">Publish Post</button>
        <p id="status-msg"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>
    <script type="module">
        import { config } from './config.js';

        let githubToken = null;
        let simplemde = null;
        let currentSha = null;
        let currentPath = null;
        let currentDate = null;

        // Repo Details
        const REPO_OWNER = 'lucaa2000';
        const REPO_NAME = 'lucaa2000.github.io';

        window.login = async function() {
            const password = document.getElementById('password-input').value;
            const errorMsg = document.getElementById('login-error');
            
            try {
                if (config.data.length === 0) {
                    throw new Error("Configuration not found. Please run setup.html first.");
                }

                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
                );

                const key = await window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: new Uint8Array(config.salt), iterations: 100000, hash: "SHA-256" },
                    keyMaterial, { name: "AES-GCM", length: 256 }, true, ["decrypt"]
                );

                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: new Uint8Array(config.iv) },
                    key,
                    new Uint8Array(config.data)
                );

                githubToken = new TextDecoder().decode(decrypted);
                
                // If successful, show editor
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('editor-screen').classList.remove('hidden');
                
                // Init Markdown Editor
                simplemde = new SimpleMDE({ element: document.getElementById("post-body") });

                // Load posts
                loadPosts();

            } catch (e) {
                console.error(e);
                errorMsg.innerText = "Incorrect password or invalid configuration.";
            }
        };

        window.loadPosts = async function() {
            const list = document.getElementById('posts-list');
            list.innerHTML = '<p style="text-align:center">Loading...</p>';

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/_posts`, {
                    headers: { 'Authorization': `Bearer ${githubToken}` }
                });
                const data = await response.json();
                
                if (!Array.isArray(data)) throw new Error("Failed to load posts");

                list.innerHTML = '';
                const ul = document.createElement('ul');
                ul.style.listStyle = 'none';
                ul.style.padding = '0';

                // Sort by name (date) descending
                data.sort((a, b) => b.name.localeCompare(a.name));

                data.forEach(file => {
                    if (!file.name.endsWith('.md')) return;

                    const li = document.createElement('li');
                    li.style.padding = '0.5rem';
                    li.style.borderBottom = '1px solid #eee';
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.alignItems = 'center';

                    const name = document.createElement('span');
                    name.innerText = file.name.replace('.md', '');
                    
                    const btn = document.createElement('button');
                    btn.innerText = 'Edit';
                    btn.style.padding = '0.25rem 0.5rem';
                    btn.style.fontSize = '0.8rem';
                    btn.onclick = () => loadPost(file.path, file.sha);

                    li.appendChild(name);
                    li.appendChild(btn);
                    ul.appendChild(li);
                });
                list.appendChild(ul);

            } catch (e) {
                list.innerHTML = `<p class="error">Error loading posts: ${e.message}</p>`;
            }
        };

        window.loadPost = async function(path, sha) {
            const status = document.getElementById('status-msg');
            status.innerText = "Loading post...";
            
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
                    headers: { 'Authorization': `Bearer ${githubToken}` }
                });
                const data = await response.json();
                
                // Decode content
                const content = decodeURIComponent(escape(atob(data.content)));
                
                // Parse Frontmatter
                const parts = content.split('---');
                if (parts.length < 3) throw new Error("Invalid post format");
                
                const frontmatter = parts[1];
                const body = parts.slice(2).join('---').trim();

                // Extract title
                const titleMatch = frontmatter.match(/title:\s*"(.*)"/) || frontmatter.match(/title:\s*(.*)/);
                const title = titleMatch ? titleMatch[1] : "";

                // Extract date
                const dateMatch = frontmatter.match(/date:\s*(.*)/);
                currentDate = dateMatch ? dateMatch[1].trim() : new Date().toISOString();

                // Set Editor
                document.getElementById('post-title').value = title;
                simplemde.value(body);
                
                // Set State
                currentSha = data.sha;
                currentPath = path;
                
                document.getElementById('form-title').innerText = "Edit Post: " + path.split('/').pop();
                document.getElementById('publish-btn').innerText = "Update Post";
                status.innerText = "";

            } catch (e) {
                status.innerText = "Error loading post: " + e.message;
                status.style.color = "red";
            }
        };

        window.resetEditor = function() {
            document.getElementById('post-title').value = '';
            simplemde.value('');
            currentSha = null;
            currentPath = null;
            currentDate = null;
            document.getElementById('form-title').innerText = "Write a New Post";
            document.getElementById('publish-btn').innerText = "Publish Post";
            document.getElementById('status-msg').innerText = "";
        };

        window.publish = async function() {
            const title = document.getElementById('post-title').value;
            const body = simplemde.value();
            const btn = document.getElementById('publish-btn');
            const status = document.getElementById('status-msg');

            if (!title || !body) {
                alert('Please fill in title and content');
                return;
            }

            btn.disabled = true;
            status.innerText = currentSha ? "Updating..." : "Publishing...";

            let filename = currentPath;
            let dateToUse = currentDate;

            if (!filename) {
                // Create filename slug for new post
                const date = new Date();
                dateToUse = date.toISOString();
                const dateOnly = dateToUse.split('T')[0];
                const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
                filename = `_posts/${dateOnly}-${slug}.md`;
            }

            // Create Frontmatter
            const fileContent = `---
layout: post
title: "${title.replace(/"/g, '\\"')}"
date: ${dateToUse}
---

${body}`;

            // Base64 encode (handle unicode)
            const contentEncoded = btoa(unescape(encodeURIComponent(fileContent)));

            const bodyPayload = {
                message: currentSha ? `Update post: ${title}` : `New post: ${title}`,
                content: contentEncoded
            };

            if (currentSha) {
                bodyPayload.sha = currentSha;
            }

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bodyPayload)
                });

                if (response.ok) {
                    status.innerText = currentSha ? "Success! Post updated." : "Success! Post published.";
                    status.style.color = "green";
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    const err = await response.json();
                    throw new Error(err.message);
                }
            } catch (e) {
                status.innerText = "Error: " + e.message;
                status.style.color = "red";
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>